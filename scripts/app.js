const wfnamebtn=document.querySelector(".wfnamebtn"),wfname=document.querySelector(".wfname"),tfblock=document.querySelector(".tfblock"),wft=document.querySelector(".wft"),wfAddBlock=document.querySelector(".wfAddBlock");let activeWorkflowFilter="progress";const optSlider=document.querySelector(".optSlider");optSlider.addEventListener("click",(e=>{const t=e.target.closest(".opt");t&&(optSlider.querySelectorAll(".opt").forEach((e=>e.classList.remove("sel"))),t.classList.add("sel"),activeWorkflowFilter=t.dataset.filter,renderHome())}));let workflowSearchQuery="";const searchInput=document.querySelector(".sInput input");function subtemp(e){return`\n<div class="subt">\n            <div class="subt_title">\n                                    <div class="tchkbox">\n                                        <i class="fa-light fa-square"></i> ${e}. \n                                    </div>\n                                    <div class="titleinput">\n                                        <input spellcheck="false" type="text" placeholder="Subtask name">\n                                    </div>\n                                </div>\n                            </div>\n`}searchInput.addEventListener("input",(e=>{workflowSearchQuery=e.target.value.toLowerCase(),renderHome()})),wfnamebtn.onclick=function(){const e=wfname.value;e.trim()?e.trim().length>30?(wfname.value="",alert("Name too long")):e.trim().length<3?alert("Name too short"):(wft.innerText=e,tfblock.style.display="none",wfAddBlock.style.display="block",setTimeout((()=>{const e=wfAddBlock.querySelector(".mst_title input");e&&e.focus()}),0)):(wfname.value="",alert("Please enter a valid name"))};const addsubtbtn=document.querySelector(".addsubtbtn");function getLastInput(e,t){const o=e.querySelectorAll(t);return o[o.length-1]}function isEmptyInput(e){return!e||!e.value.trim()}function createSubtask(e){const t=document.createElement("div");return t.className="subt",t.innerHTML=`\n        <div class="subt_title">\n            <div class="tchkbox">\n                <i class="fa-light fa-square"></i> ${e}. \n            </div>\n            <div class="titleinput">\n                <input spellcheck="false" type="text" placeholder="Subtask name">\n            </div>\n        </div>\n    `,t}function createMilestone(e){const t=document.createElement("div");return t.className="mst",t.innerHTML=`\n        <div class="mst_title">\n            <div class="tchkbox">\n                <i class="fa-light fa-square"></i> ${e}. \n            </div>\n            <div class="titleinput">\n                <input spellcheck="false" type="text" placeholder="Milestone name">\n            </div>\n        </div>\n\n        <div class="subtwhole">\n            <div class="sdummywrap"></div>\n\n            <div class="addsubtbtn">\n                <button><i class="fa-light fa-plus"></i> add new subtask</button>\n            </div>\n        </div>\n    `,t}document.addEventListener("click",(function(e){if(!e.target.closest(".addsubtbtn"))return;const t=e.target.closest(".addsubtbtn").closest(".mst").querySelector(".sdummywrap"),o=t.querySelectorAll(".subt");if(o.length>0){if(!o[o.length-1].querySelector("input").value.trim())return void alert("Please fill the previous subtask first")}const l=createSubtask(o.length+1);t.appendChild(l),setTimeout((()=>{l.querySelector("input")?.focus()}),0)}));const addMstBtn=document.querySelector(".addmstbtn button"),mswhole=document.querySelector(".mswhole");addMstBtn.onclick=function(){const e=mswhole.querySelectorAll(".mst");if(!e[e.length-1].querySelector(".mst_title input").value.trim())return void alert("Please fill the previous milestone title");const t=createMilestone(e.length+1);mswhole.insertBefore(t,document.querySelector(".addmstbtn")),setTimeout((()=>{t.querySelector(".mst_title input")?.focus()}),0)};const createBtn=document.querySelector(".crtbtnwrap button");function loadWorkflows(){const e=localStorage.getItem("workflows");return e?JSON.parse(e).workflows:[]}function saveWorkflows(e){localStorage.setItem("workflows",JSON.stringify({workflows:e}))}function getWorkflowMeta(e){const t=e.milestones.length;let o=0,l=0,s=0;e.milestones.forEach((e=>{const t=e.subtasks.length,n=e.subtasks.filter((e=>e.completed)).length;l+=t,s+=n,t>0&&(e.completed=n===t),e.completed&&o++,0===t&&(l+=1,e.completed&&(s+=1))}));const n=0===l?0:Math.round(s/l*100);return{total:t,completed:o,percent:n}}createBtn.onclick=function(){const e=document.querySelectorAll(".wfAddBlock .mst");if(0===e.length)return void alert("Please add at least one milestone");const t={id:Date.now(),name:wft.innerText,followOrder:!0,milestones:[]};for(let o of e){const e=o.querySelector(".mst_title input");if(!e.value.trim())return void alert("Please fill all milestone titles before creating");const l={title:e.value.trim(),completed:!1,subtasks:[]},s=o.querySelectorAll(".subt input");for(let e of s){if(!e.value.trim())return void alert("Please fill all subtask titles before creating");l.subtasks.push({title:e.value.trim(),completed:!1})}t.milestones.push(l)}const o=localStorage.getItem("workflows"),l=o?JSON.parse(o):{workflows:[]};l.workflows.push(t),localStorage.setItem("workflows",JSON.stringify(l)),console.log("Saved to localStorage:",l),addNewContainer.classList.add("silent"),homeLayout.classList.remove("silent"),resetCreateView(),setWorkflowFilter("progress"),renderHome()};const homeLayout=document.querySelector(".homeLayout"),indexes=homeLayout.querySelector(".indexes");function renderHome(){indexes.innerHTML="";loadWorkflows().forEach((e=>{const t=getWorkflowMeta(e);if(workflowSearchQuery&&!e.name.toLowerCase().includes(workflowSearchQuery))return;const o=t.completed===t.total;if("progress"===activeWorkflowFilter&&o)return;if("completed"===activeWorkflowFilter&&!o)return;const l=document.createElement("div");l.className="wflow",l.innerHTML=`\n            <div class="wtop">\n                <div class="wtitle">${e.name}</div>\n                <div class="wmst">${t.completed}/${t.total}</div>\n            </div>\n            <div class="wprog">\n                <div class="pbar">\n                    <div class="slider" style="width:${t.percent}%"></div>\n                </div>\n            </div>\n        `,l.onclick=()=>openWorkflow(e.id),indexes.appendChild(l)}))}const wfView=document.querySelector(".wfView"),wfViewTitle=wfView.querySelector(".wfvT"),wfViewMsWrap=wfView.querySelector(".mswhole"),wfViewProg=wfView.querySelector(".indic"),wfViewCurr=wfView.querySelector(".currprog");let activeWorkflow=null;function openWorkflow(e){const t=loadWorkflows();activeWorkflow=t.find((t=>t.id===e)),activeWorkflow&&(homeLayout.classList.add("silent"),wfView.classList.remove("silent"),renderWorkflowView())}function renderWorkflowView(){wfViewTitle.innerText=activeWorkflow.name,wfViewMsWrap.innerHTML="";const e=getWorkflowMeta(activeWorkflow);wfViewCurr.innerText=`${e.completed}/${e.total}`,wfViewProg.innerText=`${e.percent}% completed`,wfView.querySelector(".slider").style.width=`${e.percent}%`,activeWorkflow.milestones.forEach(((e,t)=>{const o=document.createElement("div");o.className="msx viewmst",o.innerHTML=`\n        <div class="msv_title">\n            <div class="tchkbox mstchk">\n                <i class=" ${e.completed?"fa-solid fa-check-square":"fa-light fa-square"}"></i>\n                <span class="itno"> ${t+1}.</span>\n            </div>\n            <div class="titledisp">\n                <p>${e.title}</p>\n            </div>\n        </div>\n        <div class="subtwhole">\n            <div class="sdummywrap"></div>\n        </div>\n    `;const l=o.querySelector(".mstchk");0===e.subtasks.length&&(l.classList.add("clickable"),l.onclick=()=>{if(activeWorkflow.followOrder){const t=activeWorkflow.milestones.indexOf(e);if(t>0&&!activeWorkflow.milestones[t-1].completed)return void alert("Please complete the previous milestone first.")}e.completed=!e.completed;const t=loadWorkflows(),o=t.findIndex((e=>e.id===activeWorkflow.id));t[o]=activeWorkflow,saveWorkflows(t),renderWorkflowView()});const s=o.querySelector(".sdummywrap");e.subtasks.forEach((t=>{const o=document.createElement("div");o.className="subt viewsubt",o.innerHTML=`\n                <div class="subt_title">\n                    <div class="tchkbox wftch">\n                        <i class=" ${t.completed?"fa-solid fa-check-square":"fa-light fa-square"}"></i>\n                    </div>\n                    <div class="subtitledisp">\n                        <p>${t.title}</p>\n                    </div>\n                </div>\n            `,o.onclick=()=>toggleSubtask(t,e),s.appendChild(o)})),wfViewMsWrap.appendChild(o)}))}function toggleSubtask(e,t){if(!e.completed&&activeWorkflow.followOrder){const o=activeWorkflow.milestones.indexOf(t);if(o>0){const e=activeWorkflow.milestones[o-1];if(!(e.subtasks.length>0?e.subtasks.every((e=>e.completed)):e.completed))return void alert("Please complete the previous milestone first.")}const l=t.subtasks.indexOf(e);if(l>0&&!t.subtasks[l-1].completed)return void alert("Please complete the previous subtask first.")}e.completed=!e.completed,t.completed=t.subtasks.every((e=>e.completed)),saveWorkflowChanges(),renderWorkflowView()}function saveWorkflowChanges(){const e=loadWorkflows(),t=e.findIndex((e=>e.id===activeWorkflow.id));-1!==t&&(e[t]=activeWorkflow,saveWorkflows(e))}wfView.querySelector(".bck").onclick=()=>{wfView.classList.add("silent"),homeLayout.classList.remove("silent"),renderHome()},document.addEventListener("DOMContentLoaded",(()=>{renderHome()}));const createNewBtn=document.querySelector(".cn"),addNewContainer=document.querySelector(".addNewContainer");createNewBtn.onclick=()=>{homeLayout.classList.add("silent"),wfView.classList.add("silent"),addNewContainer.classList.remove("silent"),setTimeout((()=>{wfname.focus()}),0)};const closeCreateBtn=document.querySelector(".closer");function resetCreateView(){wfname.value="",wft.innerText="",tfblock.style.display="flex",wfAddBlock.style.display="none";const e=document.querySelector(".wfContainer .mswhole"),t=e.querySelector(".mst");e.querySelectorAll(".mst:not(:first-child)").forEach((e=>e.remove())),t.querySelector(".mst_title input").value="",t.querySelector(".sdummywrap").innerHTML="",t.querySelector(".tchkbox").innerHTML='<i class="fa-light fa-square"></i> 1.';if(!e.querySelector(".addmstbtn")){const t=document.createElement("div");t.className="addmstbtn",t.innerHTML='<button><i class="fa-light fa-plus"></i> add new milestone</button>',e.appendChild(t)}}closeCreateBtn.onclick=()=>{addNewContainer.classList.add("silent"),homeLayout.classList.remove("silent")};const wfCloseBtn=document.querySelector(".wf-close-btn");wfCloseBtn.onclick=()=>{confirm("Discard this workflow? All changes will be lost.")&&(addNewContainer.classList.add("silent"),homeLayout.classList.remove("silent"),resetCreateView())};const wfMoreBtn=document.querySelector(".wf-more"),wfMenu=document.querySelector(".wf-menu");wfMoreBtn.onclick=e=>{e.stopPropagation(),wfMenu.classList.toggle("silent")},document.addEventListener("click",(()=>{wfMenu.classList.add("silent")}));const deleteBtn=document.querySelector(".wf-delete");function setWorkflowFilter(e){activeWorkflowFilter=e;document.querySelector(".optSlider").querySelectorAll(".opt").forEach((t=>{t.classList.toggle("sel",t.dataset.filter===e)})),console.log("Filter set to:",e)}deleteBtn.onclick=()=>{if(!confirm(`Delete workflow "${activeWorkflow.name}"?\nThis action cannot be undone.`))return;saveWorkflows(loadWorkflows().filter((e=>e.id!==activeWorkflow.id))),activeWorkflow=null,wfMenu.classList.add("silent"),wfView.classList.add("silent"),homeLayout.classList.remove("silent"),renderHome()};
